<!--
 * TencentBlueKing is pleased to support the open source community by making 蓝鲸智云-DB管理系统(BlueKing-BK-DBM) available.
 *
 * Copyright (C) 2017-2023 THL A29 Limited, a Tencent company. All rights reserved.
 *
 * Licensed under the MIT License (the "License"); you may not use this file except in compliance with the License.
 * You may obtain a copy of the License athttps://opensource.org/licenses/MIT
 *
 * Unless required by applicable law or agreed to in writing, software distributed under the License is distributed
 * on an "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied. See the License for
 * the specific language governing permissions and limitations under the License.
-->

<template>
  <div class="alert-group">
    <div class="alert-group-operations mb-16">
      <AuthButton
        action-id="notify_group_create"
        theme="primary"
        @click="handleOpenDetail('add')">
        {{ t('新建') }}
      </AuthButton>
      <BkInput
        v-model="keyword"
        class="search-input"
        clearable
        :placeholder="t('请输入告警组名称')"
        type="search"
        @clear="fetchTableData"
        @enter="fetchTableData" />
    </div>
    <DbTable
      ref="tableRef"
      class="alert-group-table"
      :columns="columns"
      :data-source="getAlarmGroupList"
      releate-url-query
      :row-class="setRowClass"
      :show-overflow="false"
      @request-success="handleRequestSuccess" />
    <DetailDialog
      v-model="detailDialogShow"
      :biz-id="currentBizId"
      :detail-data="detailData"
      :name-list="nameList"
      :type="detailType"
      @successed="fetchTableData" />
  </div>
</template>

<script setup lang="tsx">
  import { InfoBox } from 'bkui-vue';
  import { useI18n } from 'vue-i18n';
  import { useRequest } from 'vue-request';

  import NoticGroupModel from '@services/model/notice-group/notice-group';
  import { getUserGroupList } from '@services/source/cmdb';
  import { deleteAlarmGroup, getAlarmGroupList } from '@services/source/monitorNoticeGroup';
  import type { ListBase } from '@services/types';

  import { useGlobalBizs } from '@stores';

  import TextOverflowLayout from '@components/text-overflow-layout/Index.vue';

  import { messageSuccess } from '@utils';

  import DetailDialog from './components/DetailDialog.vue';
  import RenderRow from './components/RenderRow.vue';

  interface TableRenderData {
    data: NoticGroupModel;
  }

  interface UserGroupMap {
    [key: string]: ServiceReturnType<typeof getUserGroupList>[number];
  }

  const { t } = useI18n();
  const { currentBizId } = useGlobalBizs();
  const router = useRouter();

  const columns = [
    {
      field: 'name',
      fixed: 'left',
      label: t('告警组名称'),
      render: ({ data }: TableRenderData) => (
        <TextOverflowLayout>
          {{
            append: () => (
              <>
                {data.is_built_in && (
                  <bk-tag
                    class='ml-4'
                    size='small'>
                    {t('内置')}
                  </bk-tag>
                )}
                {data.isNew && (
                  <bk-tag
                    class='ml-4'
                    size='small'
                    theme='success'>
                    NEW
                  </bk-tag>
                )}
              </>
            ),
            default: () => {
              if (data.is_built_in) {
                return (
                  <bk-button
                    theme='primary'
                    text
                    onClick={() => handleOpenDetail('edit', data)}>
                    {data.name}
                  </bk-button>
                );
              }
              return (
                <auth-button
                  actionId='notify_group_update'
                  permission={data.permission.notify_group_update}
                  resource={data.id}
                  theme='primary'
                  text
                  onClick={() => handleOpenDetail('edit', data)}>
                  {data.name}
                </auth-button>
              );
            },
          }}
        </TextOverflowLayout>
      ),
      showOverflow: false,
      width: 240,
    },
    {
      field: 'recipient',
      label: t('通知对象'),
      minWidth: 400,
      render: ({ data }: TableRenderData) => {
        const userGroup = userGroupMap.value;

        if (Object.keys(userGroup).length) {
          const receivers = data.receivers.map((item) => {
            if (item.type === 'group') {
              return userGroup[item.id];
            }
            return {
              ...item,
              display_name: item.id,
              logo: '',
              members: [],
            };
          });

          return <RenderRow data={receivers} />;
        }
      },
    },
    {
      field: 'relatedPolicyCount',
      label: t('应用策略'),
      render: ({ data }: TableRenderData) => {
        const { used_count: usedCount } = data;

        return usedCount ? (
          <bk-button
            theme='primary'
            text
            onClick={() => toRelatedPolicy(data.id, data.db_type)}>
            {usedCount}
          </bk-button>
        ) : (
          <span>0</span>
        );
      },
      width: 100,
    },
    {
      field: 'update_at',
      label: t('更新时间'),
      render: ({ data }: TableRenderData) => <span>{data.updateAtDisplay || '--'}</span>,
      sort: true,
      width: 250,
    },
    {
      field: 'updater',
      label: t('更新人'),
      render: ({ data }: TableRenderData) => <span>{data.updater || '--'}</span>,
      width: 180,
    },
    {
      fixed: 'right',
      label: t('操作'),
      render: ({ data }: TableRenderData) => (
        <>
          <auth-button
            actionId='notify_group_create'
            class='mr-8'
            permission={data.permission.notify_group_create}
            theme='primary'
            text
            onClick={() => handleOpenDetail('copy', data)}>
            {t('克隆')}
          </auth-button>
          {!data.is_built_in && (
            <auth-button
              actionId='notify_group_update'
              class='mr-8'
              permission={data.permission.notify_group_update}
              resource={data.id}
              theme='primary'
              text
              onClick={() => handleOpenDetail('edit', data)}>
              {t('编辑')}
            </auth-button>
          )}
          {!data.is_built_in && (
            <auth-button
              action-id='notify_group_delete'
              permission={data.permission.notify_group_delete}
              resource={data.id}
              theme='primary'
              text
              onClick={() => handleDelete(data.id)}>
              {t('删除')}
            </auth-button>
          )}
        </>
      ),
      showOverflow: false,
      width: 100,
    },
  ];

  const tableRef = ref();
  const keyword = ref('');
  const detailDialogShow = ref(false);
  const detailType = ref<'add' | 'edit' | 'copy'>('add');
  const detailData = ref({} as NoticGroupModel);
  const nameList = ref<string[]>([]);
  const userGroupMap = shallowRef<UserGroupMap>({});

  useRequest(getUserGroupList, {
    defaultParams: [{ bk_biz_id: currentBizId }],
    onSuccess(userGroupList) {
      userGroupMap.value = userGroupList.reduce(
        (userGroupPrev, userGroup) =>
          Object.assign({}, userGroupPrev, {
            [userGroup.id]: userGroup,
          }),
        {} as UserGroupMap,
      );
    },
  });

  const fetchTableData = () => {
    tableRef.value.fetchData(
      {
        name: keyword.value,
      },
      {
        bk_biz_id: currentBizId,
      },
    );
  };

  const setRowClass = (data: NoticGroupModel) => (data.isNew ? 'is-new' : '');

  const toRelatedPolicy = (notifyGroupId: number, dbType: string) => {
    const routerData = router.resolve({
      name: 'DBMonitorStrategy',
      params: {
        bizId: currentBizId,
      },
      query: {
        dbType,
        notifyGroupId,
      },
    });

    window.open(routerData.href, '_blank');
  };

  const handleOpenDetail = (type: 'add' | 'edit' | 'copy', row?: NoticGroupModel) => {
    detailDialogShow.value = true;
    detailType.value = type;
    if (row) {
      detailData.value = row;
    }
  };

  const handleDelete = (id: number) => {
    InfoBox({
      content: t('删除后将无法恢复'),
      onConfirm: async () => {
        await deleteAlarmGroup({ id });
        messageSuccess(t('删除成功'));
        fetchTableData();
      },
      title: t('确认删除该告警组'),
      type: 'warning',
    });
  };

  const handleRequestSuccess = (tableData: ListBase<NoticGroupModel[]>) => {
    nameList.value = tableData.results.map((tableItem) => tableItem.name);
  };

  onMounted(() => {
    fetchTableData();
  });
</script>

<style lang="less" scoped>
  .alert-group {
    .alert-group-operations {
      display: flex;

      .search-input {
        width: 500px;
        margin-left: auto;
      }
    }

    :deep(.alert-group-table) {
      .name-cell {
        display: flex;
        align-items: center;

        .name-button {
          display: block;
          overflow: hidden;
          line-height: 1.5;
          flex: 0 1 auto;

          .bk-button-text {
            display: block;
            overflow: hidden;
            line-height: inherit;
            text-overflow: ellipsis;
            white-space: nowrap;
          }
        }
      }

      .is-new {
        td {
          background-color: #f3fcf5 !important;
        }
      }
    }
  }
</style>
