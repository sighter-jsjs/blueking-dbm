<template>
  <div class="openarea-template-detail-priv-rule">
    <div class="mb-16">
      <BkInput style="width: 520px" />
    </div>
    <DbTable
      ref="tableRef"
      :cell-class="cellClassCallback"
      :columns="columns"
      :container-height="600"
      :data-source="getPermissionRules"
      :show-overflow="false" />
  </div>
</template>
<script setup lang="tsx">
  import { useI18n } from 'vue-i18n';

  import MysqlPermissionAccountModel from '@services/model/mysql/mysql-permission-account';
  import { getPermissionRules } from '@services/source/mysqlPermissionAccount';

  interface Props {
    clusterId: number;
    ruleIdList: number[];
  }

  const props = defineProps<Props>();

  const { t } = useI18n();

  const tableRef = ref();

  const rowFlodMap = ref<Record<string, boolean>>({});

  const columns = [
    {
      field: 'user',
      label: t('账号名称'),
      render: ({ data }: { data: MysqlPermissionAccountModel }) => (
        <div class='account-box'>
          <db-icon
            class={{
              'flod-flag': true,
              'is-flod': rowFlodMap.value[data.account.user],
            }}
            style={{
              opacity: data.rules.length < 2 ? 0 : 1,
            }}
            type='down-shape'
            onClick={() => handleToogleExpand(data.account.user)}
          />
          <bk-button
            theme='primary'
            text>
            {data.account.user}
          </bk-button>
        </div>
      ),
      width: 220,
    },
    {
      field: 'access-db',
      label: t('访问DB'),
      render: ({ data }: { data: MysqlPermissionAccountModel }) => {
        if (data.rules.length < 1) {
          return '--';
        }

        const renderRules = rowFlodMap.value[data.account.user] ? data.rules.slice(0, 1) : data.rules;

        return renderRules.map((item) => (
          <div class='inner-row'>
            <bk-tag>{item.access_db}</bk-tag>
          </div>
        ));
      },
      width: 300,
    },
    {
      field: 'privilege',
      label: t('权限'),
      render: ({ data }: { data: MysqlPermissionAccountModel }) => {
        if (data.rules.length === 0) {
          return <div class='inner-row'>--</div>;
        }
        const renderRules = rowFlodMap.value[data.account.user] ? data.rules.slice(0, 1) : data.rules;
        return renderRules.map((item) => <div class='inner-row'>{item.privilege}</div>);
      },
    },
  ];

  const cellClassCallback = (data: any) => (data.field ? `cell-${data.field}` : '');

  const handleToogleExpand = (user: string) => {
    if (rowFlodMap.value[user]) {
      delete rowFlodMap.value[user];
    } else {
      rowFlodMap.value[user] = true;
    }
  };

  onMounted(() => {
    if (props.ruleIdList.length === 0) {
      return;
    }
    tableRef.value.fetchData({
      account_type: 'mysql',
      cluster_id: props.clusterId,
      rule_ids: props.ruleIdList.join(','),
    });
  });
</script>
<style lang="less">
  .openarea-template-detail-priv-rule {
    min-height: 624px;
    padding-bottom: 24px;

    .account-box {
      .flod-flag {
        display: inline-block;
        margin-right: 4px;
        cursor: pointer;
        transition: all 0.1s;

        &.is-flod {
          transform: rotateZ(-90deg);
        }
      }
    }

    .cell-privilege {
      .vxe-cell {
        padding: 0 !important;
        margin-left: -16px;

        .inner-row {
          padding-left: 32px !important;
        }
      }
    }

    .inner-row {
      display: flex;
      height: 40px;
      align-items: center;

      & ~ .inner-row {
        border-top: 1px solid #dcdee5;
      }
    }
  }
</style>
