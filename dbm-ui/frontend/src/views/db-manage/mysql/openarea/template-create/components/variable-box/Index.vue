<template>
  <div
    v-if="modelValue"
    v-clickoutside="handleClickOutside"
    class="openarea-variable-box">
    <div class="title">
      {{ t('变量') }}
    </div>
    <div
      v-bkloading="{ isLoading }"
      class="wrapper">
      <BkAlert
        class="mb-16"
        :title="t('可以在命名范式与 xxx 中使用')" />
      <RenderTable class="mt16">
        <template
          v-for="(item, index) in variableList"
          :key="`${item.name}#${index}`">
          <RenderRow
            v-if="item.name"
            :data="item"
            @add="(data: IVariable) => handleAdd(data, index)"
            @edit-change="handleRefreshList"
            @remove="handleRemove" />
          <CreateRow
            v-else
            v-model:list="variableList"
            @create-change="handleRefreshList" />
        </template>
      </RenderTable>
    </div>
    <div
      class="close-btn"
      @click="handleClose">
      <DbIcon type="close" />
    </div>
  </div>
</template>
<script setup lang="tsx">
  import _ from 'lodash';
  import { useI18n } from 'vue-i18n';
  import { useRequest } from 'vue-request';

  import { getBizSettingList } from '@services/source/bizSetting';
  import { updateVariable } from '@services/source/openarea';

  import { useGlobalBizs } from '@stores';

  import { BizSettingKeys } from '@common/const';

  import { messageSuccess } from '@utils';

  import CreateRow from './components/CreateRow.vue';
  import RenderRow from './components/Row.vue';
  import RenderTable from './components/Table.vue';

  export interface IVariable {
    builtin: boolean;
    desc: string;
    name: string;
  }

  const modelValue = defineModel<boolean>({
    default: false,
  });

  const { t } = useI18n();
  const { currentBizId } = useGlobalBizs();

  const variableList = shallowRef<IVariable[]>([]);

  const { loading: isLoading, run: fetchVariableList } = useRequest(getBizSettingList, {
    manual: true,
    onSuccess(data) {
      variableList.value = _.sortBy(data[BizSettingKeys.OPEN_AREA_VARS], (item) => !item.builtin);
    },
  });

  const { run: deleteVariableMethod } = useRequest(updateVariable<'delete'>, {
    manual: true,
    onSuccess() {
      messageSuccess(t('删除成功'));
      fetchData();
    },
  });

  const fetchData = () => {
    fetchVariableList({
      bk_biz_id: currentBizId,
      key: BizSettingKeys.OPEN_AREA_VARS,
    });
  };

  watch(modelValue, () => {
    if (modelValue.value) {
      fetchData();
    }
  });

  const handleClickOutside = () => {
    modelValue.value = false;
  };

  const handleAdd = (variable: IVariable, index: number) => {
    const lastVariableList = [...variableList.value];
    lastVariableList.splice(index + 1, 0, variable);
    variableList.value = lastVariableList;
  };

  const handleRefreshList = () => {
    fetchData();
  };

  const handleRemove = (variable: IVariable) => {
    deleteVariableMethod({
      new_var: undefined,
      old_var: {
        ...variable,
      },
      op_type: 'delete',
    });
  };

  const handleClose = () => {
    modelValue.value = false;
  };
</script>
<style lang="less">
  .openarea-variable-box {
    position: fixed;
    top: 104px;
    right: 0;
    bottom: 0;
    z-index: 99;
    width: 600px;
    background-color: #fff;
    box-shadow: -1px 0 0 0 #dcdee5;

    .bk-vxe-table {
      .vxe-body--row {
        .copy-btn {
          cursor: pointer;
          opacity: 0%;
        }

        &:hover {
          .copy-btn {
            color: #3a84ff;
            opacity: 100%;
            transition: 0.1s;
          }
        }
      }
    }

    .title {
      display: flex;
      height: 52px;
      padding-left: 24px;
      box-shadow: inset 0 -1px 0 0 #dcdee5;
      align-items: center;
    }

    .wrapper {
      padding: 16px;

      .action-btn {
        display: inline-flex;
        font-size: 14px;
        color: #c4c6cc;
        cursor: pointer;
        transition: all 0.15s;

        &:hover {
          color: #979ba5;
        }

        &.is-disabled {
          color: #dcdee5;
          cursor: not-allowed;
        }
      }
    }

    .close-btn {
      position: absolute;
      top: 5px;
      right: 5px;
      display: flex;
      width: 26px;
      height: 26px;
      font-size: 22px;
      color: #979ba5;
      cursor: pointer;
      border-radius: 50%;
      align-items: center;
      justify-content: center;

      &:hover {
        background-color: #f0f1f5;
      }
    }
  }
</style>
